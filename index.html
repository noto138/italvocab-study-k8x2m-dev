<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Italian Vocab Practice</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSXRhbGlhbiBWb2NhYiBQcmFjdGljZSIsInNob3J0X25hbWUiOiJJdGFsaWFuVm9jYWIiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzJlN2QzMiIsInRoZW1lX2NvbG9yIjoiIzJlN2QzMiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNakFpSUdobGFXZG9kRDBpTVRJd0lqNDhZMmx5WTJ4bElHTjRQU0kyTUNJZ1kzazlJall3SWlCeVBTSTBNQ0lnWm1sc2JEMGlJekpsTnpRek1pSXZQangwWlhoMElIZ3lQU0kyTUNJZ2VUSTlJelFpSUhOMGVXeGxQU0ptYVd4c09pTjNhR2wwWlZ0bWIyNTBMWE5wZW1VNk1URndlQ0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK1NVUkJQQzkwWlhoMFBqd3ZjM1puUGc9PSIsInNpemVzIjoiMTIweDEyMCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .practice-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .word-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 2px dashed #dee2e6;
        }

        .selected-words {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .word-tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.2em;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        }

        .word-main-line {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .inline-gender {
            font-size: 0.8em;
            font-weight: 700;
            margin-right: 6px;
            padding: 2px 5px;
            border-radius: 8px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .inline-gender.feminine {
            background: rgba(231, 76, 60, 0.3);
            color: #fff;
            border: 1px solid rgba(231, 76, 60, 0.6);
        }
        
        .inline-gender.masculine {
            background: rgba(52, 152, 219, 0.3);
            color: #fff;
            border: 1px solid rgba(52, 152, 219, 0.6);
        }
        
        .inline-translation {
            font-size: 0.9em;
            font-style: italic;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .category-label {
            font-size: 0.9em;
            opacity: 0.95;
            margin-left: 5px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .empty-state {
            color: #6c757d;
            font-style: italic;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-large {
            flex: 2;
            min-width: 160px;
        }

        .btn-small {
            flex: 1;
            min-width: 80px;
        }

        .hint-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hint-controls .btn {
            flex: 1;
            min-width: 140px;
        }

        .settings-section {
            margin-top: 20px;
        }

        .category-group {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 2px solid #e9ecef;
        }

        .category-title {
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        .word-count {
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .word-item {
            background: #f8f9fa;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #dee2e6;
            position: relative;
        }

        .word-item:hover {
            background: #e9ecef;
        }

        .remove-word {
            color: #dc3545;
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .add-word-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .add-word-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 0.9em;
            min-width: 120px;
        }

        .add-word-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 1em;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .word-selection {
            margin-bottom: 20px;
        }

        .word-selection label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .word-selection input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .level-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .level-selector label {
            font-weight: 600;
            margin-right: 10px;
            color: #495057;
        }

        .speaker-icon, .copy-icon, .dict-icon {
            cursor: pointer;
            margin: 0 5px;
            font-size: 1.2em;
            opacity: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));
            transition: all 0.2s;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            padding: 2px 4px;
        }
        
        .speaker-icon:hover, .copy-icon:hover, .dict-icon:hover {
            transform: scale(1.3);
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.9));
            background: rgba(255,255,255,0.3);
        }

        .import-section {
            margin-bottom: 30px;
        }

        .import-section h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .import-section p {
            color: #6c757d;
            margin-bottom: 15px;
        }

        .import-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .import-controls .btn {
            margin: 5px;
        }

        .import-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .import-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .import-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .search-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-input-container {
            position: relative;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            font-size: 0.9em;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-word {
            font-weight: 600;
            color: #495057;
        }

        .suggestion-details {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }

        .suggestion-custom {
            background: #e3f2fd;
            border-left: 3px solid #1976d2;
        }

        .suggestion-item.active {
            background: #e3f2fd;
        }

        .no-suggestions {
            padding: 12px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls, .hint-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🇮🇹 Italian Vocab</h1>
            <p>Practice with random words</p>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" data-tab="practice">Practice</button>
                <button class="tab" data-tab="manage">Manage Words</button>
            </div>

            <div class="tab-content active" id="practice">
                <div class="practice-section">
                    <div class="level-selector">
                        <label for="skillLevel">Difficulty Level:</label>
                        <select id="skillLevel" onchange="switchLevel()">
                            <option value="beginner">Principiante (Beginner)</option>
                            <option value="intermediate">Intermedio (Intermediate)</option>
                            <option value="advanced">Avanzato (Advanced)</option>
                        </select>
                    </div>

                    <div class="word-selection">
                        <label>
                            <input type="checkbox" id="includeNouns" checked> 
                            Sostantivi (<span id="nounCount">0</span>) - 
                            <input type="number" id="nounNumber" value="1" min="0" max="5"> words
                        </label>
                        <label>
                            <input type="checkbox" id="includeVerbs" checked> 
                            Verbi (<span id="verbCount">0</span>) - 
                            <input type="number" id="verbNumber" value="1" min="0" max="5"> words
                        </label>
                        <label>
                            <input type="checkbox" id="includeAdjectives" checked> 
                            Aggettivi (<span id="adjectiveCount">0</span>) - 
                            <input type="number" id="adjectiveNumber" value="1" min="0" max="5"> words
                        </label>
                        <label>
                            <input type="checkbox" id="includeAdverbs"> 
                            Avverbi (<span id="adverbCount">0</span>) - 
                            <input type="number" id="adverbNumber" value="1" min="0" max="5"> words
                        </label>
                    </div>

                    <div class="word-display">
                        <div class="selected-words" id="selectedWords">
                            <div class="empty-state">Click "Get New Words" to start practicing!</div>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="btn btn-large" onclick="getRandomWords()">Get New Words</button>
                        <button class="btn btn-secondary btn-small" onclick="clearWords()">Clear</button>
                    </div>

                    <div class="hint-controls">
                        <button class="btn btn-secondary" id="genderHintBtn" onclick="showGenderHints()" style="display: none;">Show Gender Hints</button>
                        <button class="btn btn-secondary" id="translationHintBtn" onclick="showTranslationHints()" style="display: none;">Show English Translations</button>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="manage">
                <div class="import-section">
                    <div class="import-controls">
                        <h3>Import Word Lists</h3>
                        <p>Load JSON files with vocabulary organized by skill level</p>
                        <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadJSONFile(event)">
                        <input type="file" id="customWordsInput" accept=".json" style="display: none;" onchange="loadCustomWordsFile(event)">
                        <button class="btn" onclick="document.getElementById('jsonFileInput').click()">Load JSON File</button>
                        <button class="btn btn-secondary" onclick="downloadSampleJSON()">Download Sample JSON</button>
                        <br>
                        <button class="btn" onclick="downloadCustomWords()" style="background: #28a745;">Backup My Custom Words</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('customWordsInput').click()">Restore Custom Words</button>
                    </div>
                    <div class="import-status" id="importStatus"></div>
                </div>

                <div class="import-section">
                    <div class="import-controls">
                        <h3>Search Vocabulary</h3>
                        <p>Type to search through all vocabulary - results appear as you type</p>
                        <div class="search-container">
                            <div class="search-input-container">
                                <input type="text" id="searchInput" placeholder="Start typing an Italian word..." style="padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; width: 100%; font-size: 1em;">
                                <div class="search-suggestions" id="searchSuggestions"></div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="clearSearch()" style="margin-top: 10px;">Clear Search</button>
                    </div>
                    <div class="import-status" id="searchResults" style="display: none;"></div>
                </div>

                <div class="settings-section">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>Add Custom Words</h3>
                        <p style="color: #6c757d;">Use the search above to check if a word already exists before adding it as custom</p>
                    </div>
                    
                    <div class="category-group">
                        <div class="category-header">
                            <span class="category-title">Sostantivi (Nouns)</span>
                            <span class="word-count" id="nounCountManage">0 words</span>
                        </div>
                        <div style="margin-bottom: 10px; font-size: 0.9em; color: #6c757d;">
                            Custom words only (⭐ = your additions):
                        </div>
                        <div class="word-list" id="nounList"></div>
                        <div class="add-word-form">
                            <input type="text" class="add-word-input" id="newNoun" placeholder="Italian word (e.g., casa)">
                            <select class="add-word-input" id="nounGender" style="width: auto;">
                                <option value="">Gender</option>
                                <option value="m">Masculine (m)</option>
                                <option value="f">Feminine (f)</option>
                            </select>
                            <input type="text" class="add-word-input" id="nounTranslation" placeholder="English translation">
                            <button class="add-word-btn" onclick="addCustomWord('nouns')">Add</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <div class="category-header">
                            <span class="category-title">Verbi (Verbs)</span>
                            <span class="word-count" id="verbCountManage">0 words</span>
                        </div>
                        <div style="margin-bottom: 10px; font-size: 0.9em; color: #6c757d;">
                            Custom words only (⭐ = your additions):
                        </div>
                        <div class="word-list" id="verbList"></div>
                        <div class="add-word-form">
                            <input type="text" class="add-word-input" id="newVerb" placeholder="Italian verb (e.g., mangiare)">
                            <input type="text" class="add-word-input" id="verbTranslation" placeholder="English translation">
                            <button class="add-word-btn" onclick="addCustomWord('verbs')">Add</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <div class="category-header">
                            <span class="category-title">Aggettivi (Adjectives)</span>
                            <span class="word-count" id="adjectiveCountManage">0 words</span>
                        </div>
                        <div style="margin-bottom: 10px; font-size: 0.9em; color: #6c757d;">
                            Custom words only (⭐ = your additions):
                        </div>
                        <div class="word-list" id="adjectiveList"></div>
                        <div class="add-word-form">
                            <input type="text" class="add-word-input" id="newAdjective" placeholder="Italian adjective (e.g., bello)">
                            <input type="text" class="add-word-input" id="adjectiveTranslation" placeholder="English translation">
                            <button class="add-word-btn" onclick="addCustomWord('adjectives')">Add</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <div class="category-header">
                            <span class="category-title">Avverbi (Adverbs)</span>
                            <span class="word-count" id="adverbCountManage">0 words</span>
                        </div>
                        <div style="margin-bottom: 10px; font-size: 0.9em; color: #6c757d;">
                            Custom words only (⭐ = your additions):
                        </div>
                        <div class="word-list" id="adverbList"></div>
                        <div class="add-word-form">
                            <input type="text" class="add-word-input" id="newAdverb" placeholder="Italian adverb (e.g., velocemente)">
                            <input type="text" class="add-word-input" id="adverbTranslation" placeholder="English translation">
                            <button class="add-word-btn" onclick="addCustomWord('adverbs')">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize word lists with some starter Italian words (organized by skill level)
        const defaultWordLists = {
            beginner: {
                nouns: [
                    {"word": "casa", "gender": "f", "translation": "house"},
                    {"word": "tempo", "gender": "m", "translation": "time"},
                    {"word": "vita", "gender": "f", "translation": "life"},
                    // ... [placeholder for more words]
                    ],
                verbs: [
                    {"word": "essere", "translation": "to be"},
                    {"word": "avere", "translation": "to have"},
                    {"word": "fare", "translation": "to do/make"},
                    // ... [placeholder for more words]
                    ],
                adjectives: [
                    {"word": "grande", "translation": "big/large"},
                    {"word": "piccolo", "translation": "small"},
                    {"word": "grosso", "translation": "big/thick"},
                    // ... [placeholder for more words]
                    ],
                adverbs: [
                    {"word": "molto", "translation": "very/much"},
                    {"word": "poco", "translation": "little"},
                    {"word": "troppo", "translation": "too much"},
                    // ... [placeholder for more words]
                    ]
                },
            
            intermediate: {
                nouns: [
                    {"word": "società", "gender": "f", "translation": "society"},
                    {"word": "economia", "gender": "f", "translation": "economy"},
                    // ... [placeholder for more words]
                    ],
                verbs: [
                    {"word": "stabilire", "translation": "to establish"},
                    {"word": "fondare", "translation": "to found"},
                    // ... [placeholder for more words]
                    ],
                adjectives: [
                    {"word": "pubblico", "translation": "public"},
                    {"word": "privato", "translation": "private"},
                    // ... [placeholder for more words]
                    ],
                adverbs: [
                    {"word": "personalmente", "translation": "personally"},
                    {"word": "privatamente", "translation": "privately"},
                    // ... [placeholder for more words]
                    ]
                },
            advanced: {
                nouns: [
                    {"word": "costituzione", "gender": "f", "translation": "constitution"},
                    {"word": "democrazia", "gender": "f", "translation": "democracy"},
                    // ... [placeholder for more words]
                    ],
                verbs: [
                    {"word": "approssimativamente", "translation": "approximately"},
                    {"word": "costituzionalmente", "translation": "constitutionally"},
                    // ... [placeholder for more words]
                    ],
                adjectives: [
                    {"word": "costituzionale", "translation": "constitutional"},
                    {"word": "democratico", "translation": "democratic"},
                    // ... [placeholder for more words]
                    ],
                adverbs: [
                    {"word": "approssimativamente", "translation": "approximately"},
                    {"word": "costituzionalmente", "translation": "constitutionally"},
                    // ... [placeholder for more words]
                    ]
                }
        };

        // Function to pronounce Italian words using ResponsiveVoice
        function pronounceWord(word) {
            if (typeof responsiveVoice !== 'undefined') {
                responsiveVoice.speak(word, "Italian Male", {
                    rate: 0.95,
                    pitch: 1,
                    volume: 1
                });
            } else {
                console.log('ResponsiveVoice not loaded yet');
                alert('Pronunciation feature is still loading. Please try again in a moment.');
            }
        }

        // Copy word to clipboard
        function copyToClipboard(word) {
            navigator.clipboard.writeText(word).then(() => {
                console.log(`Copied "${word}" to clipboard`);
                
                const copyIcons = document.querySelectorAll('.copy-icon');
                copyIcons.forEach(icon => {
                    if (icon.onclick.toString().includes(word)) {
                        const originalText = icon.textContent;
                        icon.textContent = '✓';
                        setTimeout(() => {
                            icon.textContent = originalText;
                        }, 1000);
                    }
                });
            }).catch(err => {
                console.error('Failed to copy to clipboard:', err);
                alert(`Copy this word: ${word}`);
            });
        }

        // Open Italian dictionary in new tab
        function openDictionary(word) {
            const dictionaryUrl = `https://www.dizionario-italiano.it/dizionario-italiano.php?parola=${encodeURIComponent(word)}`;
            window.open(dictionaryUrl, '_blank');
        }

        // Current skill level and word lists
        let currentLevel = 'beginner';
        let allWordLists = {...defaultWordLists};
        let wordLists = allWordLists[currentLevel];
        let currentSelectedWords = [];
        
        // Custom words that appear in all difficulty levels
        let customWords = {
            nouns: [],
            verbs: [],
            adjectives: [],
            adverbs: []
        };

        // Switch difficulty level
        function switchLevel() {
            const levelSelect = document.getElementById('skillLevel');
            currentLevel = levelSelect.value;
            wordLists = allWordLists[currentLevel];
            
            updateWordCounts();
            updateWordLists();
            clearWords();
            
            console.log(`Switched to ${currentLevel} level`);
        }

        // Get random words based on user selection
        function getRandomWords() {
            console.log('Getting random words...');
            const selectedWords = [];
            
            const categories = [
                { name: 'nouns', checkboxId: 'includeNouns', numberId: 'nounNumber', singularName: 'noun' },
                { name: 'verbs', checkboxId: 'includeVerbs', numberId: 'verbNumber', singularName: 'verb' },
                { name: 'adjectives', checkboxId: 'includeAdjectives', numberId: 'adjectiveNumber', singularName: 'adjective' },
                { name: 'adverbs', checkboxId: 'includeAdverbs', numberId: 'adverbNumber', singularName: 'adverb' }
            ];
            
            categories.forEach(cat => {
                const checkbox = document.getElementById(cat.checkboxId);
                const numberInput = document.getElementById(cat.numberId);
                
                if (checkbox && checkbox.checked) {
                    const builtInWords = wordLists[cat.name] || [];
                    const customWordsForCategory = customWords[cat.name] || [];
                    const allWords = [...builtInWords, ...customWordsForCategory];
                    
                    console.log(`${cat.name}: built-in=${builtInWords.length}, custom=${customWordsForCategory.length}, total=${allWords.length}`);
                    
                    if (allWords.length > 0) {
                        const count = Math.min(parseInt(numberInput.value) || 1, allWords.length);
                        const shuffled = [...allWords].sort(() => 0.5 - Math.random());
                        
                        for (let i = 0; i < count; i++) {
                            const item = shuffled[i];
                            selectedWords.push({
                                word: typeof item === 'object' ? item.word : item,
                                category: cat.singularName,
                                gender: typeof item === 'object' ? item.gender : null,
                                translation: typeof item === 'object' ? item.translation : null,
                                isCustom: typeof item === 'object' ? item.isCustom : false
                            });
                        }
                    }
                }
            });

            currentSelectedWords = selectedWords;
            displaySelectedWords(selectedWords);
            
            // Show/hide hint buttons
            const hasNouns = selectedWords.some(item => 
                (item.category === 'sostantivo' || item.category === 'noun') && item.gender
            );
            const hasAnyWords = selectedWords.length > 0;
            
            document.getElementById('genderHintBtn').style.display = hasNouns ? 'inline-block' : 'none';
            document.getElementById('translationHintBtn').style.display = hasAnyWords ? 'inline-block' : 'none';
        }

        // Display selected words with custom word styling
        function displaySelectedWords(words) {
            const container = document.getElementById('selectedWords');
            
            if (words.length === 0) {
                container.innerHTML = '<div class="empty-state">No words selected. Check your settings and try again.</div>';
                return;
            }

            container.innerHTML = words.map(item => {
                const customStyle = item.isCustom ? 'style="color: #ffffff; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3); background: linear-gradient(45deg, #b39ddb, #9575cd);"' : '';
                const customIndicator = item.isCustom ? '⭐ ' : '';
                
                return `<div class="word-tag" ${customStyle}>
                    <div class="word-main-line">
                        ${item.gender && (item.category === 'sostantivo' || item.category === 'noun') ? 
                            `<span class="inline-gender ${item.gender === 'f' ? 'feminine' : 'masculine'}" style="display: none;">(${item.gender})</span>` : ''}
                        ${customIndicator}${item.word}
                        <span class="speaker-icon" onclick="pronounceWord('${item.word}')" title="Click to hear pronunciation">🔊</span>
                        <span class="copy-icon" onclick="copyToClipboard('${item.word}')" title="Copy word to clipboard">📋</span>
                        <span class="dict-icon" onclick="openDictionary('${item.word}')" title="Look up in Italian dictionary">📖</span>
                        <span class="category-label">(${item.category})</span>
                    </div>
                    ${item.translation ? `<div class="inline-translation" style="display: none;">${item.translation}</div>` : ''}
                </div>`;
            }).join('');
        }

        // Clear selected words
        function clearWords() {
            document.getElementById('selectedWords').innerHTML = 
                '<div class="empty-state">Click "Get New Words" to start practicing!</div>';
            currentSelectedWords = [];
            document.getElementById('genderHintBtn').style.display = 'none';
            document.getElementById('translationHintBtn').style.display = 'none';
        }

        function showGenderHints() {
            const inlineGenders = document.querySelectorAll('.inline-gender');
            
            // Toggle inline gender indicators
            inlineGenders.forEach(gender => {
                gender.style.display = gender.style.display === 'none' ? 'inline-block' : 'none';
            });
        }

        function showTranslationHints() {
            const inlineTranslations = document.querySelectorAll('.inline-translation');
            
            // Toggle inline translations
            inlineTranslations.forEach(translation => {
                translation.style.display = translation.style.display === 'none' ? 'block' : 'none';
            });
        }

        // Live search functionality
        function performLiveSearch(searchTerm) {
            if (!searchTerm || searchTerm.length < 1) {
                hideSuggestions();
                return;
            }
            
            const results = [];
            const maxResults = 50; // Limit results to keep performance good
            
            // Search through all difficulty levels and categories
            Object.keys(allWordLists).forEach(level => {
                Object.keys(allWordLists[level]).forEach(category => {
                    const words = allWordLists[level][category] || [];
                    words.forEach(wordItem => {
                        const word = typeof wordItem === 'object' ? wordItem.word : wordItem;
                        if (word.toLowerCase().includes(searchTerm.toLowerCase()) && results.length < maxResults) {
                            results.push({
                                word: word,
                                level: level,
                                category: category.slice(0, -1),
                                gender: typeof wordItem === 'object' ? wordItem.gender : null,
                                translation: typeof wordItem === 'object' ? wordItem.translation : null,
                                isCustom: false
                            });
                        }
                    });
                });
            });
            
            // Also search custom words
            Object.keys(customWords).forEach(category => {
                const words = customWords[category] || [];
                words.forEach(wordItem => {
                    const word = typeof wordItem === 'object' ? wordItem.word : wordItem;
                    if (word.toLowerCase().includes(searchTerm.toLowerCase()) && results.length < maxResults) {
                        results.push({
                            word: word,
                            level: 'custom',
                            category: category.slice(0, -1),
                            gender: typeof wordItem === 'object' ? wordItem.gender : null,
                            translation: typeof wordItem === 'object' ? wordItem.translation : null,
                            isCustom: true
                        });
                    }
                });
            });
            
            // Sort results: exact matches first, then by length, then alphabetically
            results.sort((a, b) => {
                const aExact = a.word.toLowerCase() === searchTerm.toLowerCase();
                const bExact = b.word.toLowerCase() === searchTerm.toLowerCase();
                if (aExact && !bExact) return -1;
                if (!aExact && bExact) return 1;
                if (a.word.length !== b.word.length) return a.word.length - b.word.length;
                return a.word.localeCompare(b.word);
            });
            
            displaySuggestions(results, searchTerm);
        }

        // Display search suggestions
        function displaySuggestions(results, searchTerm) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (results.length === 0) {
                suggestionsContainer.innerHTML = `<div class="no-suggestions">No matches found for "${searchTerm}"<br><small>You can add it as a custom word below</small></div>`;
                suggestionsContainer.style.display = 'block';
                return;
            }
            
            const suggestionsHtml = results.map(result => {
                const genderDisplay = result.gender ? ` (${result.gender})` : '';
                const translationDisplay = result.translation ? ` - ${result.translation}` : '';
                const customClass = result.isCustom ? ' suggestion-custom' : '';
                const customIndicator = result.isCustom ? '⭐ ' : '';
                
                return `<div class="suggestion-item${customClass}" onclick="selectSuggestion('${result.word.replace(/'/g, "\\'")}', '${result.level}', '${result.category}')">
                    <div class="suggestion-word">${customIndicator}${result.word}${genderDisplay}</div>
                    <div class="suggestion-details">${result.level} ${result.category}${translationDisplay}</div>
                </div>`;
            }).join('');
            
            suggestionsContainer.innerHTML = suggestionsHtml;
            suggestionsContainer.style.display = 'block';
        }

        // Hide suggestions
        function hideSuggestions() {
            document.getElementById('searchSuggestions').style.display = 'none';
        }

        // Select a suggestion
        function selectSuggestion(word, level, category) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = word;
            hideSuggestions();
            
            // Show detailed info about the selected word
            showSearchResults(`<strong>Selected: ${word}</strong><br>Found in: ${level} ${category}`, 'success');
        }

        // Search for a word in all vocabulary lists (legacy function - now simplified)
        function searchWord() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                showSearchResults('Please enter a word to search for.', 'error');
                return;
            }
            performLiveSearch(searchTerm);
        }

        // Add new custom word to a category
        function addCustomWord(category) {
            let word, translation, gender = null;
            
            if (category === 'nouns') {
                word = document.getElementById('newNoun').value.trim().toLowerCase();
                translation = document.getElementById('nounTranslation').value.trim();
                gender = document.getElementById('nounGender').value;
                
                if (!word || !translation || !gender) {
                    alert('Please fill in all fields for the noun (word, gender, and translation).');
                    return;
                }
            } else if (category === 'verbs') {
                word = document.getElementById('newVerb').value.trim().toLowerCase();
                translation = document.getElementById('verbTranslation').value.trim();
                
                if (!word || !translation) {
                    alert('Please fill in both the verb and its translation.');
                    return;
                }
            } else if (category === 'adjectives') {
                word = document.getElementById('newAdjective').value.trim().toLowerCase();
                translation = document.getElementById('adjectiveTranslation').value.trim();
                
                if (!word || !translation) {
                    alert('Please fill in both the adjective and its translation.');
                    return;
                }
            } else if (category === 'adverbs') {
                word = document.getElementById('newAdverb').value.trim().toLowerCase();
                translation = document.getElementById('adverbTranslation').value.trim();
                
                if (!word || !translation) {
                    alert('Please fill in both the adverb and its translation.');
                    return;
                }
            }
            
            // Auto-search for existing word before adding
            const existingWords = searchForExistingWord(word);
            
            if (existingWords.length > 0) {
                const locations = existingWords.map(r => `${r.level} ${r.category}`).join(', ');
                const shouldContinue = confirm(`⚠️ The word "${word}" already exists in: ${locations}\n\nDo you still want to add it to your custom words?`);
                
                if (!shouldContinue) {
                    return;
                }
            }
            
            // Check if word already exists in custom words
            const existingCustomWord = customWords[category].find(item => 
                (typeof item === 'object' ? item.word : item) === word
            );
            
            if (existingCustomWord) {
                alert('This word is already in your custom word list.');
                return;
            }
            
            // Add the word to custom words
            if (category === 'nouns') {
                customWords[category].push({word: word, gender: gender, translation: translation, isCustom: true});
                // Clear form
                document.getElementById('newNoun').value = '';
                document.getElementById('nounGender').value = '';
                document.getElementById('nounTranslation').value = '';
            } else {
                customWords[category].push({word: word, translation: translation, isCustom: true});
                // Clear form
                if (category === 'verbs') {
                    document.getElementById('newVerb').value = '';
                    document.getElementById('verbTranslation').value = '';
                } else if (category === 'adjectives') {
                    document.getElementById('newAdjective').value = '';
                    document.getElementById('adjectiveTranslation').value = '';
                } else if (category === 'adverbs') {
                    document.getElementById('newAdverb').value = '';
                    document.getElementById('adverbTranslation').value = '';
                }
            }
            
            saveCustomWords();
            updateWordLists();
            updateWordCounts();
            
            console.log(`Added custom ${category.slice(0, -1)}: ${word} (${translation})`);
        }

        // Helper function to search for existing word (returns results array)
        function searchForExistingWord(searchTerm) {
            const results = [];
            
            // Search through all difficulty levels and categories
            Object.keys(allWordLists).forEach(level => {
                Object.keys(allWordLists[level]).forEach(category => {
                    const words = allWordLists[level][category] || [];
                    words.forEach(wordItem => {
                        const word = typeof wordItem === 'object' ? wordItem.word : wordItem;
                        if (word.toLowerCase() === searchTerm.toLowerCase()) {
                            results.push({
                                word: word,
                                level: level,
                                category: category.slice(0, -1), // Remove 's' from category name
                                gender: typeof wordItem === 'object' ? wordItem.gender : null,
                                translation: typeof wordItem === 'object' ? wordItem.translation : null
                            });
                        }
                    });
                });
            });
            
            return results;
        }
        
        // Remove custom word from category
        function removeCustomWord(category, word) {
            customWords[category] = customWords[category].filter(item => 
                (typeof item === 'object' ? item.word : item) !== word);
            saveCustomWords();
            updateWordLists();
            updateWordCounts();
        }

        // Update word lists display - now only shows custom words
        function updateWordLists() {
            Object.keys(wordLists).forEach(category => {
                const listElement = document.getElementById(`${category.slice(0, -1)}List`);
                const countElement = document.getElementById(`${category.slice(0, -1)}CountManage`);
                
                // Only show custom words in the manage section
                const customWordsForCategory = customWords[category] || [];
                const builtInWords = wordLists[category] || [];
                
                listElement.innerHTML = customWordsForCategory.map(item => {
                    const word = typeof item === 'object' ? item.word : item;
                    
                    return `<div class="word-item" style="color: #1565c0; font-weight: 600; background: #e3f2fd; border: 2px solid #1976d2;">
                        ⭐ ${word}
                        <span class="remove-word" onclick="removeCustomWord('${category}', '${word}')">×</span>
                    </div>`;
                }).join('');
                
                // Show total count (built-in + custom) but only display custom
                const customCount = customWordsForCategory.length;
                const totalCount = builtInWords.length + customCount;
                countElement.textContent = `${totalCount} total words` + 
                    (customCount > 0 ? ` (${customCount} custom shown)` : ' (no custom words)');
            });
        }

        // Update word counts in practice tab
        function updateWordCounts() {
            // Count built-in words + custom words for each category
            const totalNouns = (wordLists.nouns?.length || 0) + (customWords.nouns?.length || 0);
            const totalVerbs = (wordLists.verbs?.length || 0) + (customWords.verbs?.length || 0);
            const totalAdjectives = (wordLists.adjectives?.length || 0) + (customWords.adjectives?.length || 0);
            const totalAdverbs = (wordLists.adverbs?.length || 0) + (customWords.adverbs?.length || 0);
            
            document.getElementById('nounCount').textContent = totalNouns;
            document.getElementById('verbCount').textContent = totalVerbs;
            document.getElementById('adjectiveCount').textContent = totalAdjectives;
            document.getElementById('adverbCount').textContent = totalAdverbs;
        }

        // Save custom words function - saves to localStorage
        function saveCustomWords() {
            try {
                localStorage.setItem('italianCustomWords', JSON.stringify(customWords));
                console.log('Custom words saved successfully');
            } catch (e) {
                console.log('Could not save custom words:', e);
            }
        }
        
        // Load saved custom words from localStorage
        function loadSavedCustomWords() {
            try {
                const saved = localStorage.getItem('italianCustomWords');
                if (saved) {
                    customWords = JSON.parse(saved);
                    console.log('Loaded saved custom words');
                }
            } catch (e) {
                console.log('Could not load saved custom words:', e);
            }
        }

        // Load JSON file with word lists
        function loadJSONFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    if (validateJSONStructure(jsonData)) {
                        allWordLists = {...allWordLists, ...jsonData};
                        wordLists = allWordLists[currentLevel];
                        updateWordCounts();
                        updateWordLists();
                        showImportStatus('JSON file loaded successfully!', 'success');
                    } else {
                        showImportStatus('Invalid JSON structure. Please check the format.', 'error');
                    }
                } catch (error) {
                    showImportStatus('Error parsing JSON file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Validate JSON structure
        function validateJSONStructure(data) {
            const requiredLevels = ['beginner', 'intermediate', 'advanced'];
            const requiredCategories = ['nouns', 'verbs', 'adjectives', 'adverbs'];
            
            const hasValidLevel = requiredLevels.some(level => data[level]);
            if (!hasValidLevel) return false;
            
            for (const level in data) {
                if (typeof data[level] !== 'object') return false;
                
                for (const category of requiredCategories) {
                    if (data[level][category] && !Array.isArray(data[level][category])) {
                        return false;
                    }
                }
            }
            
            return true;
        }

        // Show import status message
        function showImportStatus(message, type) {
            const statusDiv = document.getElementById('importStatus');
            statusDiv.textContent = message;
            statusDiv.className = `import-status ${type}`;
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Download sample JSON file
        function downloadSampleJSON() {
            const sample = {
                "beginner": {
                    "nouns": [
                        {"word": "casa", "gender": "f", "translation": "house"},
                        {"word": "amico", "gender": "m", "translation": "friend"}
                    ],
                    "verbs": [
                        {"word": "essere", "translation": "to be"},
                        {"word": "avere", "translation": "to have"}
                    ],
                    "adjectives": [
                        {"word": "bello", "translation": "beautiful"},
                        {"word": "grande", "translation": "big"}
                    ],
                    "adverbs": [
                        {"word": "bene", "translation": "well"},
                        {"word": "molto", "translation": "very"}
                    ]
                }
            };
            
            const jsonString = JSON.stringify(sample, null, 2);
            
            try {
                const blob = new Blob([jsonString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = 'italian_vocab_sample.json';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
                
                showImportStatus('Sample JSON downloaded!', 'success');
            } catch (error) {
                console.error('Download failed:', error);
                showImportStatus('Download failed - check console', 'error');
            }
        }

        // Download custom words as backup
        function downloadCustomWords() {
            if (!customWords || Object.keys(customWords).every(key => customWords[key].length === 0)) {
                showImportStatus('No custom words to backup!', 'error');
                return;
            }
            
            const backup = {
                timestamp: new Date().toISOString(),
                customWords: customWords
            };
            
            const jsonString = JSON.stringify(backup, null, 2);
            
            try {
                const blob = new Blob([jsonString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `italian_custom_words_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
                
                showImportStatus('Custom words backup downloaded!', 'success');
            } catch (error) {
                console.error('Backup failed:', error);
                showImportStatus('Backup failed - check console', 'error');
            }
        }

        // Load custom words from backup file
        function loadCustomWordsFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Check if it's a valid backup file
                    if (backupData.customWords && typeof backupData.customWords === 'object') {
                        // Merge with existing custom words or replace them
                        const shouldReplace = confirm('Do you want to REPLACE your current custom words with the backup, or MERGE them together?\n\nClick OK to REPLACE, Cancel to MERGE');
                        
                        if (shouldReplace) {
                            customWords = backupData.customWords;
                        } else {
                            // Merge custom words
                            Object.keys(backupData.customWords).forEach(category => {
                                if (Array.isArray(backupData.customWords[category])) {
                                    backupData.customWords[category].forEach(word => {
                                        const exists = customWords[category].find(existing => 
                                            (typeof existing === 'object' ? existing.word : existing) === 
                                            (typeof word === 'object' ? word.word : word)
                                        );
                                        if (!exists) {
                                            customWords[category].push(word);
                                        }
                                    });
                                }
                            });
                        }
                        
                        saveCustomWords();
                        updateWordCounts();
                        updateWordLists();
                        showImportStatus('Custom words restored successfully!', 'success');
                    } else {
                        showImportStatus('Invalid backup file format.', 'error');
                    }
                } catch (error) {
                    showImportStatus('Error reading backup file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Show search results
        function showSearchResults(message, type) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = message;
            resultsDiv.className = `import-status ${type}`;
            resultsDiv.style.display = 'block';
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            hideSuggestions();
        }

        // Setup live search event listeners
        function setupLiveSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performLiveSearch(e.target.value);
                }, 200); // Debounce search by 200ms
            });
            
            searchInput.addEventListener('focus', (e) => {
                if (e.target.value) {
                    performLiveSearch(e.target.value);
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    hideSuggestions();
                }
            });
            
            // Handle keyboard navigation
            searchInput.addEventListener('keydown', (e) => {
                const suggestions = document.querySelectorAll('.suggestion-item');
                if (suggestions.length === 0) return;
                
                let currentIndex = -1;
                suggestions.forEach((item, index) => {
                    if (item.classList.contains('active')) {
                        currentIndex = index;
                        item.classList.remove('active');
                    }
                });
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentIndex = Math.min(currentIndex + 1, suggestions.length - 1);
                    suggestions[currentIndex].classList.add('active');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentIndex = Math.max(currentIndex - 1, 0);
                    suggestions[currentIndex].classList.add('active');
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentIndex >= 0) {
                        suggestions[currentIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });
        }

        // Tab switching
        function setupTabSwitching() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    
                    if (tab.dataset.tab === 'manage') {
                        updateWordLists();
                    }
                });
            });
        }

        // Handle Enter key in input fields
        function setupKeyHandlers() {
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const target = e.target;
                    if (target.id === 'newNoun' || target.id === 'nounGender' || target.id === 'nounTranslation') {
                        addCustomWord('nouns');
                    } else if (target.id === 'newVerb' || target.id === 'verbTranslation') {
                        addCustomWord('verbs');
                    } else if (target.id === 'newAdjective' || target.id === 'adjectiveTranslation') {
                        addCustomWord('adjectives');
                    } else if (target.id === 'newAdverb' || target.id === 'adverbTranslation') {
                        addCustomWord('adverbs');
                    }
                }
            });
        }

        // Initialize the app
        function initializeApp() {
            updateWordCounts();
            updateWordLists();
            loadSavedCustomWords(); // Load any saved custom vocabulary from localStorage
            updateWordCounts(); // Update counts again after loading custom words
            updateWordLists(); // Update lists again after loading custom words
            
            // Setup event handlers after DOM is ready
            setupLiveSearch(); // Setup the live search functionality
            setupTabSwitching(); // Setup tab switching
            setupKeyHandlers(); // Setup keyboard handlers
        }

        // Wait for DOM to be ready before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbChzZWxmLnNraXBXYWl0aW5nKCkpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignYWN0aXZhdGUnLCBldmVudCA9PiB7CiAgZXZlbnQud2FpdFVudGlsKHNlbGYuY2xpZW50cy5jbGFpbSgpKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
